<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Películas Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #e50914;
            --dark-color: #121212;
            --darker-color: #0a0a0a;
            --light-color: #ffffff;
            --gray-color: #1e1e1e;
            --light-gray: #333333;
            --sports-color: #FF5722;
            --highlight-color: rgba(255, 87, 34, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background-color: var(--darker-color);
            color: var(--light-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header principal */
        .main-header {
            padding: 20px;
            background-color: var(--dark-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            color: var(--sports-color);
        }
        
        /* Buscador */
        .search-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border-radius: 30px;
            border: 1px solid var(--light-gray);
            background-color: var(--gray-color);
            color: var(--light-color);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            border-color: var(--sports-color);
            box-shadow: 0 0 0 2px rgba(255, 87, 34, 0.2);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Categorías */
        .nav-tabs {
            display: flex;
            gap: 15px;
            border-bottom: 1px solid var(--light-gray);
            overflow-x: auto;
            padding-bottom: 15px;
            justify-content: flex-start;
            flex-wrap: nowrap;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .nav-tab {
            padding: 10px 0;
            position: relative;
            cursor: pointer;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            color: var(--light-color);
        }
        
        .nav-tab.active {
            color: var(--light-color);
            font-weight: 600;
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--sports-color);
        }
        
        /* Contenido principal */
        .main-content {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }
        
        /* Player container */
        .player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        
        .player-iframe-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .player-iframe-container.rotated {
            transform: rotate(90deg);
            width: 100vh;
            height: 100vw;
            position: fixed;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            transform: translate(-50%, -50%) rotate(90deg);
        }
        
        #player-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: #000;
        }
        
        /* Controles del reproductor apilados verticalmente */
        .player-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 2010;
        }
        
        .player-btn {
            background: rgba(0, 0, 0, 0.7);
            color: var(--light-color);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.5;
            transition: opacity 0.3s ease, transform 0.2s ease;
        }
        
        .player-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .player-controls-active .player-btn {
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* Películas styles - TARJETAS MÁS PEQUEÑAS */
        .movies-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .movie-card {
            background-color: var(--gray-color);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .movie-poster {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .movie-info {
            padding: 10px;
        }
        
        .movie-title {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        
        .movie-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .movie-rating {
            color: #FFD700;
            font-weight: 600;
        }
        
        /* Vista de detalles */
        .movie-details-container {
            display: none;
            margin-bottom: 30px;
            position: relative;
        }
        
        .movie-backdrop-container {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
        }
        
        .movie-backdrop {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.4);
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--sports-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            border: none;
            width: 80px;
            height: 80px;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        
        .play-button:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .play-button img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .movie-details-content {
            position: relative;
            padding: 0 20px;
            display: flex;
            gap: 20px;
            margin-top: -80px;
            z-index: 10;
        }
        
        .movie-poster-container {
            position: relative;
            z-index: 10;
            min-width: 150px;
            margin-bottom: 15px;
        }
        
        .movie-poster-large {
            width: 150px;
            height: 225px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }
        
        .movie-poster-large:hover {
            transform: scale(1.03);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.9);
        }
        
        /* Botón de favoritos al lado del póster */
        .favorite-btn-container {
            position: absolute;
            right: -10px;
            top: 10px;
            z-index: 20;
        }
        
        .favorite-btn {
            background: var(--gray-color);
            border: 1px solid var(--sports-color);
            color: var(--light-color);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-size: 12px;
        }
        
        .favorite-btn:hover {
            background: rgba(255, 87, 34, 0.2);
        }
        
        .movie-main-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }
        
        .movie-title-large {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--light-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .movie-meta-large {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
            flex-wrap: wrap;
            font-size: 14px;
        }
        
        .movie-meta-large span {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        .movie-overview {
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
            max-width: 700px;
            font-size: 14px;
        }
        
        /* Recomendaciones */
        .recommendations-title {
            font-size: 20px;
            margin: 30px 0 15px;
            color: var(--light-color);
            font-weight: 600;
        }
        
        /* Loading indicator */
        .loading-indicator {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            display: none;
        }
        
        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: var(--sports-color);
            color: white;
            border-radius: 6px;
            font-size: 13px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* No favorites/history message */
        .no-content {
            grid-column: 1/-1;
            text-align: center;
            padding: 30px;
        }
        
        .no-content i {
            font-size: 40px;
            color: var(--sports-color);
            margin-bottom: 15px;
        }
        
        /* User menu */
        .user-menu {
            position: relative;
            display: inline-block;
        }
        
        .user-btn {
            background: var(--sports-color);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .user-menu-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--gray-color);
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .user-menu-content a {
            color: var(--light-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
        }
        
        .user-menu-content a:hover {
            background-color: var(--light-gray);
        }
        
        .user-menu-content a i {
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }
        
        .user-menu:hover .user-menu-content {
            display: block;
        }
        
        /* Favorites/History view */
        .user-view-container {
            display: none;
            padding: 20px;
        }
        
        .user-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 15px;
        }
        
        .user-view-tabs {
            display: flex;
            gap: 15px;
        }
        
        .user-view-tab {
            padding: 10px 0;
            position: relative;
            cursor: pointer;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }
        
        .user-view-tab:hover {
            color: var(--light-color);
        }
        
        .user-view-tab.active {
            color: var(--light-color);
            font-weight: 600;
        }
        
        .user-view-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--sports-color);
        }
        
        .user-view-content {
            display: none;
        }
        
        .user-view-content.active {
            display: block;
        }
        
        .user-view-back-btn {
            background: var(--gray-color);
            border: 1px solid var(--light-gray);
            color: var(--light-color);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .user-view-back-btn:hover {
            background: var(--light-gray);
        }
        
        /* Modal de selección de servidores */
        .servers-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .servers-container {
            background-color: var(--dark-color);
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .servers-title {
            font-size: 22px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--light-color);
        }
        
        .servers-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .server-btn {
            background-color: var(--gray-color);
            color: var(--light-color);
            border: none;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .server-btn:hover {
            background-color: var(--sports-color);
            transform: translateY(-2px);
        }
        
        .server-btn.active {
            background-color: var(--sports-color);
            font-weight: 600;
        }
        
        .close-servers-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: block;
            margin: 0 auto;
            transition: all 0.2s ease;
        }
        
        .close-servers-btn:hover {
            background-color: #c40812;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--light-gray);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--sports-color);
        }
        
        @media (max-width: 768px) {
            .logo {
                font-size: 22px;
            }
            
            .movie-details-content {
                flex-direction: column;
                padding: 15px;
                margin-top: -50px;
            }
            
            .movie-poster-large {
                width: 120px;
                height: 180px;
            }
            
            .movie-backdrop-container {
                height: 250px;
            }
            
            .movie-main-info {
                padding: 15px 0;
            }
            
            .favorite-btn-container {
                right: 5px;
                top: 5px;
            }
            
            .movies-container {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .user-menu-content {
                min-width: 160px;
            }
            
            .play-button {
                width: 60px;
                height: 60px;
            }
            
            .player-controls {
                top: 10px;
                right: 10px;
            }
            
            .player-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .movies-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .movie-poster {
                height: 150px;
            }
            
            .user-btn span {
                display: none;
            }
            
            .user-btn {
                padding: 8px;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                justify-content: center;
            }
            
            .play-button {
                width: 50px;
                height: 50px;
            }
            
            .player-controls {
                top: 5px;
                right: 5px;
                gap: 5px;
            }
            
            .player-btn {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .servers-container {
                padding: 20px;
            }
            
            .servers-title {
                font-size: 18px;
            }
            
            .server-btn {
                padding: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="status-indicator"></div>
    
    <!-- Reproductor modal -->
    <div class="player-container" id="player-container">
        <div class="player-iframe-container rotated" id="player-iframe-container">
            <iframe id="player-iframe" allowfullscreen sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
        <div class="player-controls" id="player-controls">
            <button class="player-btn" id="fullscreen-btn"><i class="fas fa-expand"></i></button>
            <button class="player-btn" id="close-player">❌</button>
        </div>
    </div>
    
    <!-- Modal de selección de servidores -->
    <div class="servers-modal" id="servers-modal">
        <div class="servers-container">
            <h3 class="servers-title">Selecciona un servidor</h3>
            <div class="servers-list" id="servers-list">
                <!-- Los servidores se cargarán aquí dinámicamente -->
            </div>
            <button class="close-servers-btn" id="close-servers-btn">Cancelar</button>
        </div>
    </div>
    
    <!-- Header principal - solo visible en vista de listado -->
    <header class="main-header" id="main-header">
        <div class="header-container">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-film"></i>
                    <span>PELÍCULAS</span>
                </div>
                <div class="user-menu">
                    <button class="user-btn" id="user-btn">
                        <i class="fas fa-user"></i>
                        <span>Yo</span>
                    </button>
                    <div class="user-menu-content">
                        <a href="#" id="view-favorites"><i class="fas fa-heart"></i> Favoritos</a>
                        <a href="#" id="view-history"><i class="fas fa-history"></i> Historial</a>
                    </div>
                </div>
            </div>
            
            <!-- Buscador -->
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar películas...">
            </div>
            
            <div class="nav-tabs" id="categories-tabs">
                <!-- Las categorías se cargarán aquí dinámicamente -->
            </div>
        </div>
    </header>
    
    <div class="main-content">
        <!-- Lista de películas -->
        <div class="movies-container" id="movies-container"></div>
        
        <!-- Loading indicator -->
        <div class="loading-indicator" id="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Cargando películas...
        </div>
        
        <!-- Vista de usuario (favoritos/historial) -->
        <div class="user-view-container" id="user-view-container">
            <div class="user-view-header">
                <div class="user-view-tabs">
                    <div class="user-view-tab active" data-tab="favorites">Favoritos</div>
                    <div class="user-view-tab" data-tab="history">Historial</div>
                </div>
                <button class="user-view-back-btn" id="user-view-back-btn">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
            </div>
            
            <div class="user-view-content active" id="favorites-view">
                <div class="movies-container" id="favorites-container"></div>
            </div>
            
            <div class="user-view-content" id="history-view">
                <div class="movies-container" id="history-container"></div>
            </div>
        </div>
        
        <!-- Detalles de la película -->
        <div class="movie-details-container" id="movie-details-container">
            <div class="movie-backdrop-container">
                <img class="movie-backdrop" id="movie-backdrop" src="" alt="">
                <button class="back-button" id="back-button">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
                <button class="play-button" id="play-button">
                    <img src="https://cdn-icons-png.flaticon.com/512/3964/3964502.png" alt="Reproducir">
                </button>
            </div>
                
            <div class="movie-details-content">
                <div class="movie-poster-container">
                    <img class="movie-poster-large" id="movie-poster-large" src="" alt="">
                    <!-- Botón de favoritos al lado del póster -->
                    <div class="favorite-btn-container" id="favorite-btn-container">
                        <!-- Botón se cargará dinámicamente -->
                    </div>
                </div>
                
                <div class="movie-main-info">
                    <h1 class="movie-title-large" id="movie-title-large"></h1>
                    <div class="movie-meta-large" id="movie-meta-large"></div>
                    <p class="movie-overview" id="movie-overview"></p>
                </div>
            </div>
            
            <h3 class="recommendations-title">Películas Recomendadas</h3>
            <div class="movies-container" id="recommendations-container"></div>
        </div>
    </div>

    <script>
        const BLOG_ID = '2351769460833534440';
        const API_KEY = 'AIzaSyCA8bFYFmoDncIwM38m0qBC9br9I-Ti3ZE';
        const TMDB_API_KEY = '52517fa475ff161dec17247320937c0b';
        const CACHE_KEY = 'movies_cache';
        const FAVORITES_KEY = 'movies_favorites';
        const HISTORY_KEY = 'movies_history';
        const CACHE_EXPIRATION = 24 * 60 * 60 * 1000; // 24 horas en milisegundos

        let allMovies = [];
        let uniqueCategories = new Set();
        let tmdbCache = {};
        let currentMovie = null;
        let isFullscreen = false;
        let isRotated = true; // Ahora siempre inicia rotado
        let observer = null;
        let checkIframeReadyInterval = null;
        let iframeContentLoaded = false;
        let controlsTimeout;
        let controlsActive = false;

        // Elementos del DOM
        const statusIndicator = document.getElementById('status-indicator');
        const playerContainer = document.getElementById('player-container');
        const playerIframeContainer = document.getElementById('player-iframe-container');
        let playerIframe = document.getElementById('player-iframe');
        const playerControls = document.getElementById('player-controls');
        const closePlayer = document.getElementById('close-player');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const mainHeader = document.getElementById('main-header');
        const categoriesTabs = document.getElementById('categories-tabs');
        const moviesContainer = document.getElementById('movies-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const movieDetailsContainer = document.getElementById('movie-details-container');
        const backButton = document.getElementById('back-button');
        const playButton = document.getElementById('play-button');
        const movieBackdrop = document.getElementById('movie-backdrop');
        const moviePosterLarge = document.getElementById('movie-poster-large');
        const movieTitleLarge = document.getElementById('movie-title-large');
        const movieMetaLarge = document.getElementById('movie-meta-large');
        const movieOverview = document.getElementById('movie-overview');
        const recommendationsContainer = document.getElementById('recommendations-container');
        const searchInput = document.querySelector('.search-input');
        const viewFavoritesBtn = document.getElementById('view-favorites');
        const viewHistoryBtn = document.getElementById('view-history');
        const favoriteBtnContainer = document.getElementById('favorite-btn-container');
        const userViewContainer = document.getElementById('user-view-container');
        const favoritesContainer = document.getElementById('favorites-container');
        const historyContainer = document.getElementById('history-container');
        const favoritesView = document.getElementById('favorites-view');
        const historyView = document.getElementById('history-view');
        const userViewTabs = document.querySelectorAll('.user-view-tab');
        const userViewBackBtn = document.getElementById('user-view-back-btn');
        const serversModal = document.getElementById('servers-modal');
        const serversList = document.getElementById('servers-list');
        const closeServersBtn = document.getElementById('close-servers-btn');

        // Función para normalizar texto (eliminar tildes)
        function normalizarTexto(texto) {
            return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        // Función para cargar datos del caché
        function loadFromCache() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (!cachedData) return null;
            
            const { data, timestamp } = JSON.parse(cachedData);
            
            // Verificar si el caché ha expirado
            if (Date.now() - timestamp > CACHE_EXPIRATION) {
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
            
            return data;
        }

        // Función para guardar datos en el caché
        function saveToCache(data) {
            const cacheData = {
                data: data,
                timestamp: Date.now()
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
        }

        // Sistema de Favoritos
        function getFavorites() {
            const favorites = localStorage.getItem(FAVORITES_KEY);
            return favorites ? JSON.parse(favorites) : [];
        }

        function toggleFavorite(movieId, movieTitle) {
            const favorites = getFavorites();
            const index = favorites.findIndex(fav => fav.id === movieId);
            
            if (index === -1) {
                favorites.push({ id: movieId, title: movieTitle });
                showStatus(`${movieTitle} añadida a favoritos`);
            } else {
                favorites.splice(index, 1);
                showStatus(`${movieTitle} eliminada de favoritos`);
            }
            
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
            return index === -1;
        }

        function isFavorite(movieId) {
            const favorites = getFavorites();
            return favorites.some(fav => fav.id === movieId);
        }

        function mostrarFavoritos() {
            const favorites = getFavorites();
            const favoriteMovies = allMovies.filter(movie => 
                favorites.some(fav => fav.id === movie.id)
            );
            
            if (favoriteMovies.length === 0) {
                favoritesContainer.innerHTML = `
                    <div class="no-content">
                        <i class="far fa-heart"></i>
                        <h3>No tienes películas favoritas</h3>
                        <p>Añade películas a favoritos haciendo clic en el corazón en la vista de detalles.</p>
                    </div>
                `;
            } else {
                mostrarPeliculasEnContenedor(favoriteMovies, favoritesContainer);
            }
            
            // Mostrar vista de usuario
            mainHeader.style.display = 'none';
            moviesContainer.style.display = 'none';
            movieDetailsContainer.style.display = 'none';
            userViewContainer.style.display = 'block';
            
            // Activar pestaña de favoritos
            userViewTabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector('.user-view-tab[data-tab="favorites"]').classList.add('active');
            
            favoritesView.classList.add('active');
            historyView.classList.remove('active');
        }

        // Sistema de Historial
        function getHistory() {
            const history = localStorage.getItem(HISTORY_KEY);
            return history ? JSON.parse(history) : [];
        }

        function addToHistory(movieId, movieTitle) {
            const history = getHistory();
            const existingIndex = history.findIndex(item => item.id === movieId);
            
            if (existingIndex !== -1) {
                // Mover al principio si ya existe
                const [existingItem] = history.splice(existingIndex, 1);
                history.unshift(existingItem);
            } else {
                // Agregar nuevo al principio
                history.unshift({ id: movieId, title: movieTitle, date: new Date().toISOString() });
                
                // Limitar a 50 elementos
                if (history.length > 50) {
                    history.pop();
                }
            }
            
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function mostrarHistorial() {
            const history = getHistory();
            const historyMovies = allMovies.filter(movie => 
                history.some(item => item.id === movie.id)
            );
            
            // Ordenar según el historial (más reciente primero)
            historyMovies.sort((a, b) => {
                const aHistory = history.find(item => item.id === a.id);
                const bHistory = history.find(item => item.id === b.id);
                return new Date(bHistory.date) - new Date(aHistory.date);
            });
            
            if (historyMovies.length === 0) {
                historyContainer.innerHTML = `
                    <div class="no-content">
                        <i class="far fa-clock"></i>
                        <h3>No hay películas en tu historial</h3>
                        <p>Las películas que veas aparecerán aquí.</p>
                    </div>
                `;
            } else {
                mostrarPeliculasEnContenedor(historyMovies, historyContainer);
            }
            
            // Mostrar vista de usuario
            mainHeader.style.display = 'none';
            moviesContainer.style.display = 'none';
            movieDetailsContainer.style.display = 'none';
            userViewContainer.style.display = 'block';
            
            // Activar pestaña de historial
            userViewTabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector('.user-view-tab[data-tab="history"]').classList.add('active');
            
            historyView.classList.add('active');
            favoritesView.classList.remove('active');
        }

        // Función para mostrar/ocultar controles
        function toggleControls(show = null) {
            if (show === true || (show === null && !controlsActive)) {
                playerContainer.classList.add('player-controls-active');
                controlsActive = true;
                resetControlsTimeout();
            } else if (show === false || (show === null && controlsActive)) {
                playerContainer.classList.remove('player-controls-active');
                controlsActive = false;
                clearTimeout(controlsTimeout);
            }
        }

        // Función para resetear el timeout de los controles
        function resetControlsTimeout() {
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => {
                toggleControls(false);
            }, 3000);
        }

        // Función mejorada para bloquear eventos en el iframe
        function blockEventsInIframe(iframe) {
            try {
                // 1. Bloquear window.open y ventanas emergentes
                const openBlocker = `
                    // Guardar referencia original
                    const originalOpen = window.open;
                    
                    // Sobrescribir window.open
                    window.open = function(url, name, features) {
                        console.log('[Bloqueado] Intento de ventana emergente:', url);
                        return null;
                    };
                    
                    // Bloquear window.open desde cualquier iframe anidado
                    Object.defineProperty(window, 'open', {
                        value: function() {
                            console.log('[Bloqueado] Intento de ventana emergente desde iframe');
                            return null;
                        },
                        writable: false,
                        configurable: false
                    });
                `;

                // 2. Bloquear eventos de clic y otros eventos
                const eventBlocker = `
                    // Función para bloquear eventos
                    function blockEvent(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    
                    // Lista de eventos a bloquear
                    const events = ['click', 'dblclick', 'mousedown', 'mouseup', 'contextmenu', 
                                  'keydown', 'keyup', 'touchstart', 'touchend', 'touchmove'];
                    
                    // Aplicar bloqueo a todos los eventos
                    events.forEach(event => {
                        document.addEventListener(event, blockEvent, true);
                        window.addEventListener(event, blockEvent, true);
                    });
                `;

                // 3. Bloquear redirecciones
                const redirectBlocker = `
                    // Bloquear antes de salir
                    window.onbeforeunload = function(e) {
                        e.preventDefault();
                        return "¿Estás seguro de que quieres salir?";
                    };
                    
                    // Bloquear location changes
                    const originalLocation = window.location;
                    Object.defineProperty(window, 'location', {
                        get: function() {
                            return originalLocation;
                        },
                        set: function(value) {
                            console.log('[Bloqueado] Intento de redirección a:', value);
                            return false;
                        }
                    });
                `;

                // 4. Bloquear elementos de publicidad
                const adBlocker = `
                    // Selectores de elementos de publicidad
                    const adSelectors = [
                        '.ad', '.ad-container', '.popup', '.popunder', 
                        '[class*="ad"]', '[id*="ad"]', '[class*="Ad"]',
                        '.advertisement', '.ad-banner', '.ad-wrapper',
                        '.ad-overlay', '.ad-popup', '.ad-unit',
                        '[onclick*="window.open"]', '[onclick*="redirect"]'
                    ];
                    
                    // Eliminar elementos de publicidad
                    function removeAds() {
                        adSelectors.forEach(selector => {
                            document.querySelectorAll(selector).forEach(el => {
                                el.remove();
                            });
                        });
                        
                        // Eliminar iframes de publicidad
                        document.querySelectorAll('iframe').forEach(iframe => {
                            if (!iframe.src.includes('${window.location.host}')) {
                                iframe.remove();
                            }
                        });
                    }
                    
                    // Ejecutar inicialmente
                    removeAds();
                    
                    // Configurar MutationObserver para nuevos elementos
                    const observer = new MutationObserver(mutations => {
                        mutations.forEach(mutation => {
                            mutation.addedNodes.forEach(node => {
                                if (node.nodeType === 1) {
                                    adSelectors.forEach(selector => {
                                        if (node.matches(selector)) {
                                            node.remove();
                                        }
                                        node.querySelectorAll(selector).forEach(el => {
                                            el.remove();
                                        });
                                    });
                                }
                            });
                        });
                    });
                    
                    observer.observe(document, {
                        childList: true,
                        subtree: true
                    });
                    
                    // Limpieza periódica
                    setInterval(removeAds, 1000);
                `;

                // Combinar todos los scripts
                const fullScript = openBlocker + eventBlocker + redirectBlocker + adBlocker;

                // Crear un blob para inyectar el script
                const blob = new Blob([fullScript], {type: 'application/javascript'});
                const url = URL.createObjectURL(blob);
                const script = document.createElement('script');
                script.src = url;
                
                // Inyectar en el iframe
                if (iframe.contentDocument) {
                    iframe.contentDocument.head.appendChild(script);
                    console.log("Bloqueador de anuncios inyectado correctamente");
                }
            } catch (e) {
                console.error("Error inyectando bloqueador:", e);
            }
        }

        // Función para configurar el bloqueador de anuncios
        function setupAdBlocker(iframe) {
            if (!iframe) return;
            
            // Limpiar intervalos y observers anteriores
            if (checkIframeReadyInterval) {
                clearInterval(checkIframeReadyInterval);
            }
            
            // Verificar periódicamente si el iframe está listo
            checkIframeReadyInterval = setInterval(() => {
                try {
                    if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                        clearInterval(checkIframeReadyInterval);
                        blockEventsInIframe(iframe);
                    }
                } catch (e) {
                    console.log("Error verificando iframe:", e);
                }
            }, 100);
        }

        // Función para mostrar estado
        function showStatus(message, isError = false) {
            console.log(isError ? "Error: " + message : "Info: " + message);
            statusIndicator.textContent = message;
            statusIndicator.style.backgroundColor = isError ? '#e50914' : '#4CAF50';
            statusIndicator.style.display = 'block';
            
            setTimeout(() => {
                statusIndicator.style.display = 'none';
            }, 3000);
        }

        // Función para abrir reproductor con protección mejorada
        function openPlayer(source) {
            if (!source) {
                showStatus("No hay enlace de reproducción disponible", true);
                return;
            }
            
            // Crear un nuevo iframe con sandbox mínimo
            const newIframe = document.createElement('iframe');
            newIframe.id = 'player-iframe';
            newIframe.allowFullscreen = true;
            newIframe.setAttribute('referrerpolicy', 'no-referrer');
            newIframe.setAttribute('allow', 'autoplay; fullscreen');
            
            // Sandbox con permisos mínimos necesarios
            newIframe.sandbox = 'allow-scripts allow-same-origin allow-presentation';
            
            // Reemplazar el iframe existente
            const iframeContainer = document.querySelector('.player-iframe-container');
            iframeContainer.innerHTML = '';
            iframeContainer.appendChild(newIframe);
            
            playerIframe = newIframe;
            
            // Configurar eventos
            newIframe.onload = function() {
                try {
                    // Bloquear eventos en el iframe
                    blockEventsInIframe(newIframe);
                    
                    // Bloquear desde el padre también
                    newIframe.contentWindow.open = function() {
                        return null;
                    };
                    
                    // Protección adicional contra redirecciones
                    newIframe.contentWindow.onbeforeunload = function(e) {
                        e.preventDefault();
                        return false;
                    };
                } catch (e) {
                    console.error("Error configurando protección:", e);
                }
            };
            
            // Cargar la URL
            newIframe.src = source;
            playerContainer.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Aplicar rotación automática
            playerIframeContainer.classList.add('rotated');
            isRotated = true;
            
            // Mostrar controles
            toggleControls(true);
            
            // Añadir al historial
            if (currentMovie) {
                addToHistory(currentMovie.id, currentMovie.title);
            }
            
            // Entrar en pantalla completa
            setTimeout(() => {
                toggleFullscreen();
            }, 300);
        }

        // Función para cerrar reproductor
        function closePlayerHandler() {
            if (isFullscreen) {
                toggleFullscreen();
            }
            playerContainer.style.display = 'none';
            playerIframe.src = '';
            document.body.style.overflow = 'auto';
            
            if (checkIframeReadyInterval) {
                clearInterval(checkIframeReadyInterval);
                checkIframeReadyInterval = null;
            }
            
            clearTimeout(controlsTimeout);
        }

        // Función para alternar pantalla completa
        function toggleFullscreen() {
            if (!isFullscreen) {
                if (playerContainer.requestFullscreen) {
                    playerContainer.requestFullscreen();
                } else if (playerContainer.webkitRequestFullscreen) {
                    playerContainer.webkitRequestFullscreen();
                } else if (playerContainer.msRequestFullscreen) {
                    playerContainer.msRequestFullscreen();
                }
                isFullscreen = true;
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                isFullscreen = false;
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
            resetControlsTimeout();
        }

        // Función para mostrar el modal de selección de servidores
        function showServersModal(servers) {
            serversList.innerHTML = '';
            
            if (servers.length === 0) {
                serversList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">No hay servidores disponibles</p>';
            } else {
                servers.forEach((server, index) => {
                    const serverBtn = document.createElement('button');
                    serverBtn.className = 'server-btn';
                    serverBtn.textContent = server.nombre;
                    serverBtn.onclick = () => {
                        openPlayer(server.url);
                        serversModal.style.display = 'none';
                    };
                    serversList.appendChild(serverBtn);
                });
            }
            
            serversModal.style.display = 'flex';
        }

        // Función para extraer los servidores del contenido de la película
        function extractServersFromContent(content) {
            const servers = [];
            
            // Buscar servidores en el formato: { nombre: "Servidor 1", url: "https://..." }
            const serverRegex = /{\s*nombre:\s*"([^"]+)",\s*url:\s*"([^"]+)"\s*}/g;
            let match;
            
            while ((match = serverRegex.exec(content)) !== null) {
                servers.push({
                    nombre: match[1],
                    url: match[2]
                });
            }
            
            // Si no se encontraron servidores en el formato nuevo, buscar el formato antiguo
            if (servers.length === 0) {
                const videoMatch = content.match(/const linkTransmision = "([^"]+)";/);
                if (videoMatch) {
                    servers.push({
                        nombre: "Servidor 1",
                        url: videoMatch[1]
                    });
                }
            }
            
            return servers;
        }

        // Escuchar cambios en el estado de pantalla completa
        document.addEventListener('fullscreenchange', () => {
            isFullscreen = !!document.fullscreenElement;
            fullscreenBtn.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
            resetControlsTimeout();
        });

        document.addEventListener('webkitfullscreenchange', () => {
            isFullscreen = !!document.webkitFullscreenElement;
            fullscreenBtn.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
            resetControlsTimeout();
        });

        document.addEventListener('msfullscreenchange', () => {
            isFullscreen = !!document.msFullscreenElement;
            fullscreenBtn.innerHTML = isFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
            resetControlsTimeout();
        });

        // Función para cargar todas las películas con paginación
        async function obtenerPeliculas(pageToken = null) {
            // Mostrar indicador de carga solo en la primera página
            if (!pageToken) {
                loadingIndicator.style.display = "block";
                moviesContainer.innerHTML = "";
                allMovies = [];
                uniqueCategories = new Set();
                
                // Intentar cargar del caché
                const cachedData = loadFromCache();
                if (cachedData) {
                    allMovies = cachedData.movies;
                    uniqueCategories = new Set(cachedData.categories);
                    mostrarPeliculas(allMovies);
                    mostrarCategorias();
                    loadingIndicator.style.display = "none";
                    return;
                }
            }
            
            let url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?key=${API_KEY}&maxResults=100`;
            
            if (pageToken) {
                url += `&pageToken=${pageToken}`;
            }
            
            try {
                const respuesta = await fetch(url);
                const datos = await respuesta.json();
                
                // Filtrar solo películas (excluir series y animaciones)
                const peliculas = datos.items.filter(
                    post => !post.labels || 
                           (!post.labels.includes("serie") && !post.labels.includes("animacion"))
                );
                
                // Agregar las nuevas películas
                peliculas.forEach(movie => {
                    allMovies.push(movie);
                    if (movie.labels) {
                        movie.labels.forEach(label => {
                            if (label !== 'serie' && label !== 'animacion') {
                                uniqueCategories.add(label);
                            }
                        });
                    }
                });
                
                // Si hay más páginas, seguimos cargando
                if (datos.nextPageToken) {
                    await obtenerPeliculas(datos.nextPageToken);
                } else {
                    // Cuando no hay más páginas, mostramos las películas
                    mostrarPeliculas(allMovies);
                    mostrarCategorias();
                    loadingIndicator.style.display = "none";
                    
                    // Guardar en caché
                    saveToCache({
                        movies: allMovies,
                        categories: [...uniqueCategories]
                    });
                }
            } catch (error) {
                console.error("Error al obtener películas:", error);
                loadingIndicator.style.display = "none";
                // Mostramos lo que hayamos podido cargar
                mostrarPeliculas(allMovies);
                mostrarCategorias();
            }
        }

        // Función para obtener datos de TMDB con caché
        async function obtenerDatosTMDB(titulo) {
            // Verificar si ya tenemos los datos en caché
            const cacheKey = `tmdb_${normalizarTexto(titulo)}`;
            if (tmdbCache[cacheKey]) {
                return tmdbCache[cacheKey];
            }
            
            const url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(titulo)}&language=es`;
            
            try {
                const respuesta = await fetch(url);
                const datos = await respuesta.json();

                if (datos.results && datos.results.length) {
                    const movieId = datos.results[0].id;
                    const detallesUrl = `https://api.themoviedb.org/3/movie/${movieId}?api_key=${TMDB_API_KEY}&append_to_response=credits,images&language=es`;
                    const detallesRespuesta = await fetch(detallesUrl);
                    const detalles = await detallesRespuesta.json();

                    const result = {
                        ...datos.results[0],
                        overview: detalles.overview,
                        runtime: detalles.runtime,
                        release_date: detalles.release_date,
                        images: detalles.images.backdrops
                    };
                    
                    // Almacenar en caché
                    tmdbCache[cacheKey] = result;
                    return result;
                }
            } catch (error) {
                console.error(`Error al obtener datos de TMDB para ${titulo}:`, error);
            }
            
            return null;
        }

        // Función para mostrar las categorías en las pestañas
        function mostrarCategorias() {
            categoriesTabs.innerHTML = "";

            // Agregar "Todas" como primera opción
            const allTab = document.createElement('div');
            allTab.classList.add('nav-tab', 'active');
            allTab.textContent = 'Todas';
            allTab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                allTab.classList.add('active');
                mostrarPeliculas(allMovies);
            });
            categoriesTabs.appendChild(allTab);

            // Agregar el resto de categorías
            uniqueCategories.forEach(categoria => {
                const tab = document.createElement('div');
                tab.classList.add('nav-tab');
                tab.textContent = categoria;
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    tab.classList.add('active');
                    filtrarPorCategoria(categoria);
                });
                categoriesTabs.appendChild(tab);
            });
        }

        // Función para filtrar películas por categoría
        function filtrarPorCategoria(categoria) {
            const peliculasFiltradas = allMovies.filter(movie => movie.labels && movie.labels.includes(categoria));
            mostrarPeliculas(peliculasFiltradas);
        }

        // Función para buscar películas
        function buscarPeliculas() {
            const input = searchInput.value.trim().toLowerCase();
            const normalizedInput = normalizarTexto(input);

            if (input === "") {
                const activeTab = document.querySelector('.nav-tab.active');
                if (activeTab && activeTab.textContent === 'Todas') {
                    mostrarPeliculas(allMovies);
                } else if (activeTab) {
                    filtrarPorCategoria(activeTab.textContent);
                }
                return;
            }

            const peliculasFiltradas = allMovies.filter(movie => {
                const titulo = normalizarTexto(movie.title.toLowerCase());
                return titulo.includes(normalizedInput);
            });

            mostrarPeliculas(peliculasFiltradas);
        }

        // Función para mostrar películas en un contenedor específico
        function mostrarPeliculasEnContenedor(peliculas, contenedor) {
            contenedor.innerHTML = "";

            // Mostrar las películas mientras se cargan los datos de TMDB
            for (const pelicula of peliculas) {
                const imgMatch = pelicula.content.match(/<img.*?src=["'](.+?)["'].*?>/);
                const imagen = imgMatch ? imgMatch[1] : "https://via.placeholder.com/300x450?text=No+Imagen";

                const movieCard = document.createElement('div');
                movieCard.classList.add('movie-card');
                movieCard.innerHTML = `
                    <img class="movie-poster" src="${imagen}" alt="${pelicula.title}">
                    <div class="movie-info">
                        <h3 class="movie-title">${pelicula.title}</h3>
                        <div class="movie-meta">
                            <span class="movie-rating">⭐ ...</span>
                        </div>
                    </div>
                `;
                movieCard.addEventListener('click', () => cargarDetallesPelicula(pelicula));
                contenedor.appendChild(movieCard);
            }

            // Cargar datos de TMDB en segundo plano
            setTimeout(async () => {
                for (let i = 0; i < peliculas.length; i++) {
                    const pelicula = peliculas[i];
                    const datosTMDB = await obtenerDatosTMDB(pelicula.title);
                    const puntuacion = datosTMDB ? datosTMDB.vote_average.toFixed(1) : 'N/A';
                    
                    const movieElement = contenedor.children[i];
                    if (movieElement) {
                        const ratingElement = movieElement.querySelector('.movie-rating');
                        if (ratingElement) {
                            ratingElement.textContent = `⭐ ${puntuacion}`;
                        }
                    }
                }
            }, 0);
        }

        // Función para mostrar películas (usa el contenedor principal)
        function mostrarPeliculas(peliculas) {
            mostrarPeliculasEnContenedor(peliculas, moviesContainer);
        }

        // Función para cargar detalles de una película
        async function cargarDetallesPelicula(pelicula) {
            currentMovie = pelicula;
            
            // Ocultar header principal y mostrar detalles
            mainHeader.style.display = 'none';
            moviesContainer.style.display = 'none';
            movieDetailsContainer.style.display = 'block';
            userViewContainer.style.display = 'none';

            const datosTMDB = await obtenerDatosTMDB(pelicula.title);
            const imgMatch = pelicula.content.match(/<img.*?src=["'](.+?)["'].*?>/);
            const imagen = imgMatch ? imgMatch[1] : "https://via.placeholder.com/300x450?text=No+Imagen";
            
            // Extraer servidores disponibles
            const servers = extractServersFromContent(pelicula.content);

            // Cargar imagen de fondo
            if (datosTMDB && datosTMDB.images && datosTMDB.images.length > 0) {
                movieBackdrop.src = `https://image.tmdb.org/t/p/w1280${datosTMDB.images[0].file_path}`;
            } else {
                movieBackdrop.src = imagen;
            }

            // Cargar poster
            moviePosterLarge.src = imagen;
            
            // Cargar título
            movieTitleLarge.textContent = pelicula.title;

            // Cargar metadatos principales
            let metaHTML = '';
            if (datosTMDB) {
                if (datosTMDB.release_date) {
                    metaHTML += `<span><i class="fas fa-calendar-alt"></i> ${new Date(datosTMDB.release_date).getFullYear()}</span>`;
                }
                if (datosTMDB.runtime) {
                    metaHTML += `<span><i class="fas fa-clock"></i> ${datosTMDB.runtime} min</span>`;
                }
                if (datosTMDB.vote_average) {
                    metaHTML += `<span><i class="fas fa-star"></i> ${datosTMDB.vote_average.toFixed(1)}/10</span>`;
                }
            }
            movieMetaLarge.innerHTML = metaHTML;

            // Cargar sinopsis
            movieOverview.textContent = datosTMDB && datosTMDB.overview ? datosTMDB.overview : 'Sin sinopsis disponible.';
            
            // Configurar botón de favoritos al lado del póster
            const favoriteBtnHTML = `
                <button class="favorite-btn" id="favorite-btn">
                    ${isFavorite(pelicula.id) ? '<i class="fas fa-heart"></i> En favoritos' : '<i class="far fa-heart"></i> Añadir a favoritos'}
                </button>
            `;
            favoriteBtnContainer.innerHTML = favoriteBtnHTML;
            
            // Configurar evento del botón de favoritos
            document.getElementById('favorite-btn').addEventListener('click', () => {
                const isNowFavorite = toggleFavorite(pelicula.id, pelicula.title);
                document.getElementById('favorite-btn').innerHTML = isNowFavorite ? 
                    '<i class="fas fa-heart"></i> En favoritos' : 
                    '<i class="far fa-heart"></i> Añadir a favoritos';
            });

            // Configurar botón de reproducción
            playButton.onclick = () => {
                if (servers.length === 1) {
                    // Si solo hay un servidor, reproducir directamente
                    openPlayer(servers[0].url);
                } else if (servers.length > 1) {
                    // Si hay múltiples servidores, mostrar el modal de selección
                    showServersModal(servers);
                } else {
                    // Si no hay servidores disponibles
                    showStatus("No hay enlaces de reproducción disponibles", true);
                }
            };

            // Cargar películas recomendadas
            cargarRecomendaciones(pelicula.title);
        }

        // Función para cargar películas recomendadas
        function cargarRecomendaciones(tituloActual) {
            recommendationsContainer.innerHTML = "";

            const peliculasRecomendadas = allMovies
                .filter(movie => movie.title !== tituloActual)
                .slice(0, 6);

            peliculasRecomendadas.forEach(pelicula => {
                const imgMatch = pelicula.content.match(/<img.*?src=["'](.+?)["'].*?>/);
                const imagen = imgMatch ? imgMatch[1] : "https://via.placeholder.com/300x450?text=No+Imagen";

                const movieCard = document.createElement('div');
                movieCard.classList.add('movie-card');
                movieCard.innerHTML = `
                    <img class="movie-poster" src="${imagen}" alt="${pelicula.title}">
                    <div class="movie-info">
                        <h3 class="movie-title">${pelicula.title}</h3>
                        <div class="movie-meta">
                            <span class="movie-rating">⭐ ...</span>
                        </div>
                    </div>
                `;
                movieCard.addEventListener('click', () => cargarDetallesPelicula(pelicula));
                recommendationsContainer.appendChild(movieCard);
            });

            // Cargar puntuaciones en segundo plano
            setTimeout(async () => {
                for (let i = 0; i < peliculasRecomendadas.length; i++) {
                    const pelicula = peliculasRecomendadas[i];
                    const datosTMDB = await obtenerDatosTMDB(pelicula.title);
                    const puntuacion = datosTMDB ? datosTMDB.vote_average.toFixed(1) : 'N/A';
                    
                    const movieElement = recommendationsContainer.children[i];
                    if (movieElement) {
                        const ratingElement = movieElement.querySelector('.movie-rating');
                        if (ratingElement) {
                            ratingElement.textContent = `⭐ ${puntuacion}`;
                        }
                    }
                }
            }, 0);
        }

        // Función para volver a la lista de películas
        function volverALista() {
            mainHeader.style.display = 'block';
            moviesContainer.style.display = 'grid';
            movieDetailsContainer.style.display = 'none';
            userViewContainer.style.display = 'none';
        }

        // Event listeners
        backButton.addEventListener('click', volverALista);
        closePlayer.addEventListener('click', closePlayerHandler);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        viewFavoritesBtn.addEventListener('click', mostrarFavoritos);
        viewHistoryBtn.addEventListener('click', mostrarHistorial);
        userViewBackBtn.addEventListener('click', volverALista);
        closeServersBtn.addEventListener('click', () => {
            serversModal.style.display = 'none';
        });

        // Mostrar controles al interactuar con el reproductor
        playerContainer.addEventListener('click', (e) => {
            if (!e.target.closest('#player-controls')) {
                toggleControls();
            }
        });

        // Mostrar controles al pasar el ratón sobre ellos
        playerControls.addEventListener('mouseenter', () => toggleControls(true));

        // Pestañas de vista de usuario
        userViewTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                userViewTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.user-view-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.getElementById(`${tabName}-view`).classList.add('active');
                
                if (tabName === 'favorites') {
                    const favorites = getFavorites();
                    const favoriteMovies = allMovies.filter(movie => 
                        favorites.some(fav => fav.id === movie.id)
                    );
                    mostrarPeliculasEnContenedor(favoriteMovies, favoritesContainer);
                } else {
                    const history = getHistory();
                    const historyMovies = allMovies.filter(movie => 
                        history.some(item => item.id === movie.id)
                    );
                    historyMovies.sort((a, b) => {
                        const aHistory = history.find(item => item.id === a.id);
                        const bHistory = history.find(item => item.id === b.id);
                        return new Date(bHistory.date) - new Date(aHistory.date);
                    });
                    mostrarPeliculasEnContenedor(historyMovies, historyContainer);
                }
            });
        });

        // Cerrar reproductor con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (isFullscreen) {
                    toggleFullscreen();
                } else {
                    closePlayerHandler();
                }
            }
        });

        // Buscador
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(buscarPeliculas, 300);
        });

        // Cerrar modal de servidores al hacer clic fuera
        serversModal.addEventListener('click', (e) => {
            if (e.target === serversModal) {
                serversModal.style.display = 'none';
            }
        });

        // Iniciar la carga de películas al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            obtenerPeliculas();
        });
    </script>
</body>
</html>
